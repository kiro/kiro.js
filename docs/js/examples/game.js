// Generated by CoffeeScript 1.6.3
(function() {
  var bootstrap, docs, models, store;

  docs = window.BC.namespace("docs");

  docs.examples = window.BC.namespace("docs.examples");

  bootstrap = window.BC.namespace("bootstrap");

  models = window.BC.namespace("models");

  store = window.BC.namespace("store");

  $.extend(this, bootstrap, models, docs, store);

  docs.examples.game = function() {
    return section(h1("Game"), docs.code.game(), example("Multiplayer tic tac toe", "Open if different tabs to play the game.", function() {
      var boardFull, canPlay, checkFinished, content, currentPlayer, emptyState, enterPlayerName, game, gameList, games, getId, icon, initialState, myturn, otherPlayer, player, showGame, state;
      state = {
        EMPTY: "empty",
        TIC: "tic",
        TAC: "tac"
      };
      getId = function(item) {
        return item.id;
      };
      emptyState = function() {
        return {
          value: state.EMPTY,
          mark: false
        };
      };
      initialState = function() {
        var i, j, _i, _results;
        _results = [];
        for (i = _i = 0; _i < 3; i = ++_i) {
          _results.push((function() {
            var _j, _results1;
            _results1 = [];
            for (j = _j = 0; _j < 3; j = ++_j) {
              _results1.push(emptyState());
            }
            return _results1;
          })());
        }
        return _results;
      };
      currentPlayer = null;
      player = function(name) {
        return object({
          id: guid(),
          name: name,
          lastSeen: Date.now()
        });
      };
      game = function(player) {
        var obj;
        obj = object({
          id: guid(),
          players: [player],
          turn: 0,
          state: initialState(),
          lastSeen: Date.now(),
          finished: false
        });
        window.setInterval((function() {
          return obj.lastSeen = Date.now();
        }), 10 * 1000);
        return obj;
      };
      games = collection();
      pusher(games, 'games', getId, -1, function(game1, game2) {
        if (game1.turn === game2.turn) {
          return game1.set(game2);
        }
      });
      content = model();
      boardFull = function(game) {
        var i, j, _i, _j;
        for (i = _i = 0; _i < 3; i = ++_i) {
          for (j = _j = 0; _j < 3; j = ++_j) {
            if (game.state.at(i).at(j).value === state.EMPTY) {
              return false;
            }
          }
        }
        return true;
      };
      checkFinished = function(game) {
        var check, i, _i;
        check = function(x, y, dx, dy) {
          var currentState, k, _i, _j, _results;
          currentState = game.state.at(y).at(x).value;
          for (k = _i = 0; _i < 3; k = ++_i) {
            if (game.state.at(y + dy * k).at(x + dx * k).value !== currentState) {
              currentState = void 0;
            }
          }
          if (currentState && currentState !== state.EMPTY && !game.finished) {
            game.finished = game.players.at(game.turn).name + " won!";
            _results = [];
            for (k = _j = 0; _j < 3; k = ++_j) {
              _results.push(game.state.at(y + dy * k).at(x + dx * k).mark = true);
            }
            return _results;
          }
        };
        for (i = _i = 0; _i < 3; i = ++_i) {
          check(i, 0, 0, 1);
          check(0, i, 1, 0);
        }
        check(0, 0, 1, 1);
        check(2, 0, -1, 1);
        if (boardFull(game) && !game.finished) {
          return game.finished = "Game finished.";
        }
      };
      icon = function(value) {
        if (value === state.TIC) {
          return '<i class="icon-circle-blank tic"/>';
        } else if (value === state.TAC) {
          return '<i class="icon-remove tac"/>';
        } else {
          return "";
        }
      };
      myturn = function(game) {
        return game.players.count() === 2 && game.players.at(game.turn).id === currentPlayer.id;
      };
      otherPlayer = function(game) {
        return game.players.at(game.turn);
      };
      canPlay = function(game) {
        return game.players.count() > 1 && (game.players.at(0).id === currentPlayer.id || game.players.at(1).id === currentPlayer.id);
      };
      showGame = function(game) {
        return div(h3(map(game, function() {
          if (game.players.count() <= 1) {
            return "Waiting for other player to join...";
          } else if (canPlay(game)) {
            return game.players.at(0).name + " vs " + game.players.at(1).name;
          } else {
            return "Game is full, you can just observe.";
          }
        })), h4(map(game, function() {
          if (game.players.count() >= 2) {
            if (game.finished) {
              return game.finished;
            } else {
              if (myturn(game)) {
                return "Your turn";
              } else {
                return otherPlayer(game).name + "s turn.";
              }
            }
          }
        })).bindVisible(game.players, function() {
          return canPlay(game);
        }), div({
          "class": 'board'
        }).foreach(game.state, function(row) {
          return div({
            "class": 'board-row'
          }).foreach(row, function(field) {
            return div({
              "class": 'icon4 field'
            }, map(bind(field.value), function() {
              return icon(field.value);
            })).on('click', function() {
              if (myturn(game) && field.value === state.EMPTY && !game.finished) {
                field.value = game.turn === 0 ? state.TIC : state.TAC;
                checkFinished(game);
                return game.turn = (game.turn + 1) % 2;
              }
            }).bindClass(bind(field.mark), function() {
              if (field.mark) {
                return "mark";
              }
            });
          });
        }), div({
          "class": 'padding'
        }, button.primary('Play again', function() {
          game.finished = false;
          return game.state = initialState();
        }).bindVisible(bind(game.finished)), button("Go back", function() {
          game.players.remove(matchField(getId, currentPlayer));
          return content(gameList());
        })));
      };
      gameList = function() {
        return div(h2("Create new game"), button('Create', function() {
          var newGame;
          newGame = game(currentPlayer);
          games.add(newGame);
          return content(showGame(newGame));
        }), h2("Or join an existing game"), p(span(map(games, function() {
          return games.count();
        })), " currently available"), table(thead(tr(th("Players").span3(), th("Action")))).foreach(games, function(game) {
          return tr(td(ul.inline().foreach(game.players, function(player) {
            return li(player.name);
          }), p().muted('No players').bindVisible(game.players, function() {
            return game.players.count() === 0;
          })).span3(), td(button.primary("Join", function() {
            game.players.add(currentPlayer);
            return content(showGame(game));
          }).bindVisible(game, function() {
            return game.players.count() < 2;
          }), button.info("Watch", function() {
            return content(showGame(game));
          }).bindVisible(game, function() {
            return game.players.count() === 2;
          })));
        }));
      };
      enterPlayerName = function() {
        var playerName;
        playerName = model("");
        return div(h3("Enter player name"), form.inline(input.text(playerName), button.primary("Enter", function() {
          currentPlayer = player(playerName());
          return content(gameList());
        })));
      };
      content(enterPlayerName());
      return body(div(content));
    }));
  };

}).call(this);
